<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Create Customer Link</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Create a personal link</h1>
      <p class="lead">This creates a customer link using the backend store.</p>

      <form id="createForm" novalidate>
        <div class="row">
          <div>
            <label for="name">Customer name</label>
            <input id="name" name="name" placeholder="e.g., Jane Doe" required />
          </div>
          <div>
            <label for="appId">Application ID</label>
            <input id="appId" name="appId" placeholder="e.g., A123456" required />
          </div>
        </div>
        <div class="actions">
          <button id="createBtn" type="submit">Generate Link</button>
          <a href="/admin.html" class="btn">Open Dashboard</a>
        </div>
      </form>

      <div id="result" class="urlbox" style="display:none">
        <div class="muted">Personal URL</div>
        <code id="url"></code>
        <div class="actions" style="margin-top:12px">
          <button id="copyBtn" type="button">Copy</button>
        </div>
      </div>

      <div id="error" class="muted" style="display:none"></div>
    </div>
  </div>

  <script>
    const form     = document.getElementById('createForm');
    const btn      = document.getElementById('createBtn');
    const result   = document.getElementById('result');
    const urlEl    = document.getElementById('url');
    const copyBtn  = document.getElementById('copyBtn');
    const errorBox = document.getElementById('error');

    function setBusy(b) { btn.disabled = !!b; btn.textContent = b ? 'Creatingâ€¦' : 'Generate Link'; }
    function showError(msg){ errorBox.style.display='block'; errorBox.textContent=msg; }
    function clearError(){ errorBox.style.display='none'; errorBox.textContent=''; }

    async function safeJson(res){ const t=await res.text(); try{return JSON.parse(t);}catch{return {ok:false,error:t?.slice(0,300)||'Non-JSON response'};} }

    async function createLink(payload){
      const res = await fetch('/api/links', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      const data = await safeJson(res);
      if (!res.ok || !data || data.ok === false) throw new Error((data && data.error) || `HTTP ${res.status}`);
      if (!data.slug && !data.url) throw new Error('Server did not return slug/url');
      return data;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearError(); setBusy(true);

      const fd = new FormData(form);
      const name  = (fd.get('name')  || '').trim();
      const appId = (fd.get('appId') || '').trim();
      if (!name)  { setBusy(false); return showError('Please enter the customer name.'); }
      if (!appId) { setBusy(false); return showError('Please enter the Application ID.'); }

      try {
        const data = await createLink({ name, appId });
        const url = data.url && data.url.startsWith('http') ? data.url : `${location.origin}/u/${encodeURIComponent(data.slug)}`;
        result.style.display = 'block';
        urlEl.textContent = url;
        copyBtn.onclick = async ()=>{ await navigator.clipboard.writeText(url); copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Copy',1200); };
      } catch (err) {
        showError(`Failed to create link: ${err.message || err}`);
      } finally { setBusy(false); }
    });
  </script>
</body>
</html>
